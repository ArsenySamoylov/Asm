<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>x86Backend: index</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">x86Backend
   </div>
   <div id="projectbrief">Backend for x86 for my simple programming language</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('md_index.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">index </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"&gt; &lt;html xmlns="http://www.w3.org/1999/xhtml"&gt; &lt;head&gt; &lt;meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"&gt; &lt;meta http-equiv="X-UA-Compatible" content="IE=9"&gt; &lt;meta name="generator" content="Doxygen 1.9.1"&gt; &lt;meta name="viewport" content="width=device-width, initial-scale=1"&gt; &lt;title&gt;x86Backend: Overview&lt;/title&gt; &lt;link href="tabs.css" rel="stylesheet" type="text/css"&gt; &lt;script type="text/javascript" src="jquery.js"&gt;&lt;/script&gt; &lt;script type="text/javascript" src="dynsections.js"&gt;&lt;/script&gt; &lt;link href="navtree.css" rel="stylesheet" type="text/css"&gt; &lt;script type="text/javascript" src="resize.js"&gt;&lt;/script&gt; &lt;script type="text/javascript" src="navtreedata.js"&gt;&lt;/script&gt; &lt;script type="text/javascript" src="navtree.js"&gt;&lt;/script&gt; &lt;link href="search/search.css" rel="stylesheet" type="text/css"&gt; &lt;script type="text/javascript" src="search/searchdata.js"&gt;&lt;/script&gt; &lt;script type="text/javascript" src="search/search.js"&gt;&lt;/script&gt; &lt;link href="doxygen.css" rel="stylesheet" type="text/css" &gt; &lt;/head&gt; &lt;body&gt; </p><div id="top"> <div id="titlearea"> <table cellspacing="0" cellpadding="0">
</table>
</div></div><div id="top"><div id="titlearea"> </div></div><div id="top"><div id="titlearea"> <div id="projectname">x86Backend </div> <div id="projectbrief">Backend for x86 for my simple programming language</div><p>   &lt;/tbody&gt; </div></div><div id="top"><div id="titlearea"> </div></div><div id="top">&lt;script type="text/javascript"&gt; /* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */ var searchBox = new SearchBox("searchBox", "search",false,'Search','.html'); /* @license-end */ &lt;/script&gt; &lt;script type="text/javascript" src="menudata.js"&gt;&lt;/script&gt; &lt;script type="text/javascript" src="menu.js"&gt;&lt;/script&gt; &lt;script type="text/javascript"&gt; /* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */ $(function() { initMenu('',true,false,'search.php','Search'); .ready(function() { init_search(); }); }); /* @license-end */&lt;/script&gt; <div id="main-nav"></div> </div> <div id="side-nav" class="ui-resizable side-nav-resizable"> <div id="nav-tree"> <div id="nav-tree-contents"> <div id="nav-sync" class="sync"></div> </div> </div> <div id="splitbar" style="-moz-user-select:none;" class="ui-resizable-handle"> </div> </div><p> &lt;script type="text/javascript"&gt; /* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */ .ready(function(){initNavTree('index.html',''); initResizable(); }); /* @license-end */ &lt;/script&gt; </p><div id="doc-content"></div><div id="doc-content"><div id="MSearchSelectWindow" onmouseover="return searchBox.OnSearchSelectShow()" onmouseout="return searchBox.OnSearchSelectHide()" onkeydown="return searchBox.OnSearchSelectKey(event)"> </div></div><div id="doc-content"><div id="MSearchResultsWindow"> &lt;iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults"&gt; &lt;/iframe&gt; </div></div><div id="doc-content"><div class="PageDoc"><div class="header"> <div class="headertitle"> <div class="title">Overview </div> </div> </div> <div class="contents"> <div class="textblock"></div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock">Генерирующийся ассемблерный файл для данной программы <a class="anchor" id="md_x86BackEnd_README"></a>Данный репозиторий является продолжением моего проекта по созданию компилятора для собственного простого <a href="https://github.com/ArsenySamoylov/Lang.git">языка программирования</a>. Данная часть посвящена Backend`у для х86 архитектуры.</div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock"> </div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock"><a href="documentation/html/index.html">Страница с документацией.</a></div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock"> <h1><a class="anchor" id="autotoc_md2"></a> Следующая итерация</h1>
</div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock"> </div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock">В контексте данной работы Backend - это программа переводящая Абстрактно-синтаксическое дерево (AST) в код для <code>исполнителя</code>. В первой итерации работы <code>исполнителем</code> был написанной мной <a href="https://github.com/ArsenySamoylov/CoreIArs.git">SoftCpu</a>, который имеет стековую архитектуру и небольшую область памяти, а также может выполнять простые математические операции.</div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock"> </div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock">Главными изменениями в этой итерации стали:</div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock"><ul>
<li>
переход со стековой архитектуры на регистровую, </li>
<li>
переход с виртуального исполнителя на физический (в данном случае это Intel Core i5-10300H 2.50GHz) </li>
<li>
введение промежуточного представления программы - IR код; </li>
</ul>
</div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock">Начнем с IR кода.</div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock"> </div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock">Работа компилятора разделена на три части <em>front end</em>, <em>middle-end</em> и <em>backend</em>. Так как это независимые части, то между ними нужен общий вид передачи программы. В предыдущей итерации в этой роли выступало AST дерево и разработанный нашей учебной группой специальный <a href="https://github.com/dodokek/LanguageStandart.git">стандарт</a> его хранения. Однако AST дерево слишком не похоже на машинную реализацию программы и соответственно большая часть задачи по оптимизации перекладываются на Backend, что рушит смысл разделения компилятора на три части.</div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock"> </div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock">Поэтому возникает необходимость в промежуточном представлении программы, которое больше бы походило на машинный код.</div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock"> </div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock">Так как мы переходим на регистровую архитектуру, то будем ориентироваться на уже готовые решения в этом направлении. Самым известным и распространённым решением является IR от <a href="https://llvm.org/docs/LangRef.html">LLVM` a</a>.</div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock"> </div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock">Взяв его за основу, я реализовал собственный простейший IR. Если это проект получит продолжение, то следующей итерацией будет переход на полноценное использование IR от LLVM.</div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock"> </div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock"><b>Замечание:</b> Я решил сделать собственную реализацию простейшего IR в учебных целях. Дальнейшее его развитие, на данный момент, не имеет смыслы =(.</div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock"> <h2><a class="anchor" id="autotoc_md3"></a> Описание моего IR`a</h2>
</div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock"> </div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock">IR реализован с помощью классов и наследования на языке <code>C++</code>.</div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock"> </div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock">Основной выступает абстрактный класс <code><a href="class_value.html" class="el" title="Abstract class for IR object.">Value</a></code>, который хранит <code>name</code> - имя объекта (так же <a href="class_value.html" class="el" title="Abstract class for IR object.">Value</a> хранит константу - тип конкретного объекта, что на самом деле является излишним; однако я решил оставить поле, так как это может пригодиться при отладке программы). От этого абстрактного класса наследуются классы:</div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock"><ul>
<li>
<code><a href="class_constant.html" class="el" title="Double constant.">Constant</a></code> - константа, хранит число, </li>
<li>
<code><a href="class_global_var.html" class="el" title="Global Variable.">GlobalVar</a></code> - глобальная переменная, хранит указатель на <code><a href="class_constant.html" class="el" title="Double constant.">Constant</a></code> - начальное значение переменной, </li>
<li>
<code><a href="class_instruction.html" class="el" title="Abstract class for instruction, that will be executed.">Instruction</a></code> - абстрактный класс инструкций, которые выполняются исполнителем; </li>
<li>
<code><a href="class_base_block.html" class="el" title="Block of Instructions.">BaseBlock</a></code> - массив <code><a href="class_instruction.html" class="el" title="Abstract class for instruction, that will be executed.">Instruction</a></code> <code>ов, которые должны выполняться последовательно (подробнее об этом будет написано позже), -</code><a href="class_function.html" class="el" title="Function.">Function</a><code>- функция, хранит массив</code>BaseBlockов, </li>
</ul>
</div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock">Данная иерархия описана в файле <a href="src/IR/Value/Value.h"><code>src/IR/Value/Value.h</code></a>.</div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock"> </div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock">Как было написано выше <code><a href="class_instruction.html" class="el" title="Abstract class for instruction, that will be executed.">Instruction</a></code> - это абстрактный класс, от которого наследуются классы:</div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock"><ul>
<li>
<code><a href="class_store.html" class="el" title="Instruction to allocate space for local variable.">Store</a></code> - инструкция выделения памяти для объекта <code><a href="class_value.html" class="el" title="Abstract class for IR object.">Value</a></code>, хранит указатель на <code><a href="class_value.html" class="el" title="Abstract class for IR object.">Value</a></code>, </li>
<li>
<code><a href="class_load.html" class="el" title="Instruction to load value to local var.">Load</a></code> - инструкция загрузи <code><a href="class_value.html" class="el" title="Abstract class for IR object.">Value</a></code> в память, хранит указатели на источник (src) и приемник (dest), </li>
<li>
<code><a href="struct_operator.html" class="el" title="Math operation instruction.">Operator</a></code> - математический или логическая операция, хранит указатели на операнды, </li>
<li>
<code><a href="class_branch.html" class="el" title="Instruction to pass control flow.">Branch</a></code> - инструкция передачи контроля, хранит указатель на условие и два указателя на базовые блоки (ветки); в соответствии c условием выбирается один из двух базовых блоков (веток), которому перейдет контроль выполнения программы (<em>замечание</em>: <code><a href="class_branch.html" class="el" title="Instruction to pass control flow.">Branch</a></code> это более удобный аналог инструкции <code>jmp</code>), </li>
<li>
<code><a href="class_call.html" class="el" title="Instruction to call another function.">Call</a></code> - вызов функции, хранит имя вызываемой функции и аргументы, </li>
<li>
<code><a href="struct_return.html" class="el" title="Return instruction.">Return</a></code> - инструкция возврата из функции, хранит указатель на возвращаемое значение. </li>
</ul>
</div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock">Данная иерархия описана в файле <a href="src/IR/Instructions/Instructions.h"><code>srs/IR/Instructions/Instructions.h</code></a>.</div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock"> </div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock">Класс <code><a href="class_module.html" class="el">Module</a></code>, определенный в <a href="src/IR/Module/Module.h"><code>src/IR/Module/Module.h</code></a>, является массивом объектов <code><a href="class_function.html" class="el" title="Function.">Function</a></code> и <code><a href="class_global_var.html" class="el" title="Global Variable.">GlobalVar</a></code>. Объект <code><a href="class_module.html" class="el">Module</a></code> представляет собой исходную программу на моем языке.</div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock"> <h3><a class="anchor" id="autotoc_md4"></a> Иерархии классов в IR`e</h3>
</div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock"> </div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock"><img src="resources/ValueHierarchy.png" alt="" class="inline" class="inline"/> </div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock"> <h3><a class="anchor" id="autotoc_md5"></a> Module в IR`e</h3>
</div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock"> </div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock"><img src="resources/Module.png" alt="" class="inline" class="inline"/> </div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock"> </div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock">Как было сказано выше - базовые блоки (<code><a href="class_base_block.html" class="el" title="Block of Instructions.">BaseBlock</a></code>) это массив инструкций, которые будут выполняться последовательно. Каждый базовый блок заканчивается инструкций передающей контроль - <code><a href="struct_return.html" class="el" title="Return instruction.">Return</a></code> или <code><a href="class_branch.html" class="el" title="Instruction to pass control flow.">Branch</a></code>. Благодаря последовательному исполнению инструкций возможно оптимально распределять регистры внутри базового блока.</div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock"> </div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock">Однако существует проблема оптимизации использования регистров между базовыми блоками. Это проблема достаточна сложна, поэтому мы не будем рассматривать её в данной итерации проекта.</div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock"> <h2><a class="anchor" id="autotoc_md6"></a> Пример</h2>
</div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock"> </div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock">Рассмотрим пример простой программы на моем языке. Программа высчитывает факториал от заданной константы:</div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock"> <div class="fragment"><div class="line">double factorial (var number)</div> <div class="line"> {</div> <div class="line"> if (number &gt; 1)</div> <div class="line"> return number * factorial (number - 1);</div> <div class="line"> </div> <div class="line"> return 1;</div> <div class="line"> } </div> <div class="line"> </div> <div class="line">double main ()</div> <div class="line"> {</div> <div class="line"> var result = factorial (6); </div> <div class="line"> fout &lt;&lt; result;</div> <div class="line"> </div> <div class="line"> return 0;</div> <div class="line"> }</div> </div></div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock">Её <code>IR</code> представление: </div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock"><div class="fragment"><div class="line">extern function &amp;#39;fout&amp;#39; ();</div> <div class="line"> </div> <div class="line">Declare function &amp;#39;factorial&amp;#39; (param number):</div> <div class="line">entry_factorial:</div> <div class="line"> op_0 = bigger number, 1</div> <div class="line"> br op_0, label than_0, label merge_0</div> <div class="line"> </div> <div class="line">than_0:</div> <div class="line"> op_2 = sub number, 1</div> <div class="line"> c_1 = call: factorial (param op_2)</div> <div class="line"> op_3 = mul number, c_1</div> <div class="line"> </div> <div class="line"> return op_3</div> <div class="line"> br label merge_0</div> <div class="line"> </div> <div class="line">merge_0:</div> <div class="line"> </div> <div class="line"> return 1</div> <div class="line"> </div> <div class="line"> </div> <div class="line">Declare function &amp;#39;main&amp;#39; ():</div> <div class="line">entry_main:</div> <div class="line"> c_0 = call: factorial (param 6)</div> <div class="line"> result = store(c_0)</div> <div class="line"> call: fout (param result)</div> <div class="line"> </div> <div class="line"> return 0</div> </div></div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock"> Здесь <code>declare</code> обозначает начало определения функции, метка - начало базового блока.</div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock"> </div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock">Каждая инструкция представляет собой переменную, которая может дальше использовать программой. Данный синтаксис призван подчеркнуть это, например:</div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock"> <div class="fragment"><div class="line">op_2 = sub number, 1</div> <div class="line">c_1 = call: factorial (param op_2)</div> </div></div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock"> Здесь <code>op_2</code> - это результат разности является переменной, служащий аргументом для <code>call</code> a. А <code>c_1</code> - это переменная хранящая возвращаемое значение вызова (если функция ничего не возвращает, то присваивание переменой опускается, как в строчке с вызовом <code>fout</code>).</div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock"> </div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock">При генерации исполняемого файла так же генерируется ассемблерный файл, подробно расписывающий как происходила генерация машинных команд. Это файл компилируется и сохраняет логику программы. С его помощью легко можно создать контрольный исполняемый файл, который помогает проверять правильность генерации машинных кодов.</div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock"> </div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock">Для удобства, в ассемблерном файле печатается исходная строчка из IR<code>a в виде комментария (строки начинающиеся с</code>###`), после чего идет ассемблерная реализация данной строчки.</div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock"> </div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock"><b>Замечание:</b></div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock"> </div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock">Исходная итерация имела особенность: исполнитель работал с вещественными числами заданной точностью, храня их в виде целых чисел. Для этого число умножается на константу <code>PRECISION</code> (в данном случае равной 100). Данная итерация унаследовала эту особенность. Поэтому например при умножении двух чисел результат нормируется: делится на 100.</div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock"> </div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock">&lt;details&gt;</div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock"> <div class="fragment"><div class="line"> .global main</div> <div class="line"> .extern fout</div> <div class="line"> </div> <div class="line"> .section .text</div> <div class="line">_start:</div> <div class="line"> call main </div> <div class="line"> movq $0 , rdi </div> <div class="line"> movq $60 , rax </div> <div class="line"> syscall</div> <div class="line"> </div> <div class="line">factorial:</div> <div class="line"> # set stack frame (1 local vars)</div> <div class="line"> sub $8, rsp </div> <div class="line"> push rbp </div> <div class="line"> mov rsp, rbp </div> <div class="line"> </div> <div class="line"> # save callee-save regs</div> <div class="line"> push rbx </div> <div class="line"> push r10 </div> <div class="line"> push r11 </div> <div class="line"> push r12 </div> <div class="line"> push r13 </div> <div class="line"> push r14 </div> <div class="line"> push r15 </div> <div class="line"> </div> <div class="line"> # save param regs on stack</div> <div class="line"> movq rdi, -8 (rbp) # Save &amp;#39;number&amp;#39; on stack</div> <div class="line"> </div> <div class="line"> </div> <div class="line">entry_factorial:</div> <div class="line">### op_0 = bigger number, 1</div> <div class="line"> movq $100 , r15 # put_value_to_reg: &amp;#39; const_0&amp;#39; -&gt; r15</div> <div class="line"> # put_value_to_reg: &amp;#39;number&amp;#39; already in rdi</div> <div class="line"> </div> <div class="line"> mov rdi, r14 # save &amp;#39;number&amp;#39; to r14</div> <div class="line"> </div> <div class="line"> # (generating logic op) #</div> <div class="line"> push rdx # (save rdx)</div> <div class="line"> </div> <div class="line"> cmpq r15, rdi</div> <div class="line"> setg al</div> <div class="line"> movzbq al, rax</div> <div class="line"> </div> <div class="line"> # (normalize result) #</div> <div class="line"> xor rdx, rdx</div> <div class="line"> movq $100 , rdi </div> <div class="line"> imul rdi</div> <div class="line"> mov rax, rdi # (-&gt; normalized result)</div> <div class="line"> </div> <div class="line"> pop rdx # (restore rdx)</div> <div class="line"> </div> <div class="line">### br op_0, label than_0, label merge_0</div> <div class="line"> # put_value_to_reg: &amp;#39;op_0&amp;#39; already in rdi</div> <div class="line"> cmp $100, rdi</div> <div class="line"> je than_0 </div> <div class="line"> jmp merge_0 </div> <div class="line"> </div> <div class="line"> </div> <div class="line">than_0:</div> <div class="line">### op_2 = sub number, 1</div> <div class="line"> movq $100 , rdi # put_value_to_reg: &amp;#39; const_1&amp;#39; -&gt; rdi</div> <div class="line"> # put_value_to_reg: &amp;#39;number&amp;#39; already in r14</div> <div class="line"> </div> <div class="line"> mov r14, r15 # save &amp;#39;number&amp;#39; to r15</div> <div class="line"> </div> <div class="line"> # (math op) #</div> <div class="line"> sub rdi, r14</div> <div class="line"> </div> <div class="line"> </div> <div class="line">### c_1 = call: factorial (param op_2)</div> <div class="line"> # (save busy regs) #</div> <div class="line"> # (set parameters) # </div> <div class="line"> mov r14, rdi </div> <div class="line"> call factorial </div> <div class="line"> mov rax, rdi # save call result from rax</div> <div class="line"> </div> <div class="line">### op_3 = mul number, c_1</div> <div class="line"> # put_value_to_reg: &amp;#39;c_1&amp;#39; already in rdi</div> <div class="line"> # put_value_to_reg: &amp;#39;number&amp;#39; already in r15</div> <div class="line"> </div> <div class="line"> mov r15, r14 # save &amp;#39;number&amp;#39; to r14</div> <div class="line"> </div> <div class="line"> # (generating mul/div)#</div> <div class="line"> push rdx # (save rdx)</div> <div class="line"> xor rdx, rdx</div> <div class="line"> mov r15, rax </div> <div class="line"> imul rdi</div> <div class="line"> </div> <div class="line"> # (normalize result) #</div> <div class="line"> xor rdx, rdx</div> <div class="line"> movq $100 , r15 </div> <div class="line"> idiv r15</div> <div class="line"> mov rax, r15 # (-&gt; normalized result)</div> <div class="line"> </div> <div class="line"> pop rdx # (restore rdx)</div> <div class="line"> </div> <div class="line">### return op_3</div> <div class="line"> </div> <div class="line"> mov r15, rax # return op_3</div> <div class="line"> </div> <div class="line"> # (restore callee-save regs)</div> <div class="line"> pop r15 </div> <div class="line"> pop r14 </div> <div class="line"> pop r13 </div> <div class="line"> pop r12 </div> <div class="line"> pop r11 </div> <div class="line"> pop r10 </div> <div class="line"> pop rbx </div> <div class="line"> </div> <div class="line"> # (clear stack frame)</div> <div class="line"> pop rbp </div> <div class="line"> add $8, rsp </div> <div class="line"> ret </div> <div class="line"> </div> <div class="line">### br label merge_0</div> <div class="line"> jmp merge_0 </div> <div class="line"> </div> <div class="line"> </div> <div class="line">merge_0:</div> <div class="line">### return 1</div> <div class="line"> </div> <div class="line"> movq $100 , rax # return const_2</div> <div class="line"> # restore callee-save regs</div> <div class="line"> pop r15 </div> <div class="line"> pop r14 </div> <div class="line"> pop r13 </div> <div class="line"> pop r12 </div> <div class="line"> pop r11 </div> <div class="line"> pop r10 </div> <div class="line"> pop rbx </div> <div class="line"> </div> <div class="line"> # clear stack frame</div> <div class="line"> pop rbp </div> <div class="line"> add $8, rsp </div> <div class="line"> ret </div> <div class="line"> </div> <div class="line"> </div> <div class="line">main:</div> <div class="line"> # set stack frame (1 local vars)</div> <div class="line"> sub $8, rsp </div> <div class="line"> push rbp </div> <div class="line"> mov rsp, rbp </div> <div class="line"> </div> <div class="line"> # save callee-save regs</div> <div class="line"> push rbx </div> <div class="line"> push r10 </div> <div class="line"> push r11 </div> <div class="line"> push r12 </div> <div class="line"> push r13 </div> <div class="line"> push r14 </div> <div class="line"> push r15 </div> <div class="line"> </div> <div class="line"> # save param regs on stack</div> <div class="line"> </div> <div class="line"> </div> <div class="line">entry_main:</div> <div class="line">### c_0 = call: factorial (param 6)</div> <div class="line"> # save busy regs</div> <div class="line"> # set parameters </div> <div class="line"> </div> <div class="line"> movq $600 , rdi </div> <div class="line"> call factorial </div> <div class="line"> mov rax, rdi # save call result from rax</div> <div class="line"> </div> <div class="line">### result = store(c_0)</div> <div class="line"> # put_value_to_reg: &amp;#39;c_0&amp;#39; already in rdi</div> <div class="line"> movq rdi, -8 (rbp) # copy &amp;#39;c_0&amp;#39; to stack (to &amp;#39;result&amp;#39;)</div> <div class="line"> </div> <div class="line">### call: fout (param result)</div> <div class="line"> # save busy regs</div> <div class="line"> push rdi # save: c_0</div> <div class="line"> # set parameters </div> <div class="line"> movq -8 (rbp), rdi </div> <div class="line"> call fout </div> <div class="line"> pop rdi </div> <div class="line"> </div> <div class="line">### return 0</div> <div class="line"> </div> <div class="line"> movq $0 , rax # return const_1</div> <div class="line"> # restore callee-save regs</div> <div class="line"> pop r15 </div> <div class="line"> pop r14 </div> <div class="line"> pop r13 </div> <div class="line"> pop r12 </div> <div class="line"> pop r11 </div> <div class="line"> pop r10 </div> <div class="line"> pop rbx </div> <div class="line"> </div> <div class="line"> # clear stack frame</div> <div class="line"> pop rbp </div> <div class="line"> add $8, rsp </div> <div class="line"> ret </div> </div></div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock">&lt;/details&gt;</div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock"> <h2><a class="anchor" id="autotoc_md7"></a> Стандартная библиотека</h2>
</div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock"> </div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock">Для полноценной использования языка необходима библиотека, реализующая простейшие стандартные функции. Моя реализация некоторых функций находится в файле <code>src/Elf/stdlib.s</code>. Машинный код стандартных функций берется из файла <code>src/Elf/stdlib.o</code> и добавляется в конец исполняемого файла.</div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock"> </div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock">Для создания контрольной программы с помощью генерирующегося ассемблерного кода, нужно линковать <code>src/Elf/stdlib.o</code>.</div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock"> <h1><a class="anchor" id="autotoc_md8"></a> Итог:</h1>
</div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock"> </div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock">В завершении работы замерим, как изменилось время работы программы на моем языке. Для сравнения будем использовать пример факториала из данной работы, но без вывода результата.</div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock"> <h3><a class="anchor" id="autotoc_md9"></a> Таблица: время расчета факториала от 15, 1000 раз</h3>
</div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock"> <table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Исполнитель </th><th class="markdownTableHeadNone">Время, мс </th><th class="markdownTableHeadNone">Коэффициент прироста  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">SoftCpu </td><td class="markdownTableBodyNone">70 </td><td class="markdownTableBodyNone">-  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">core i5 </td><td class="markdownTableBodyNone">1.2 </td><td class="markdownTableBodyNone">56.6  </td></tr>
</table>
</div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock">Получается, что в новой итерации исполнение программы ускорилось более чем в 50 раз! Хороший показатель (спасибо ребятам из <em>Intel</em> за такой мощный процессор ;)). </div></div></div></div><div id="doc-content"><div class="PageDoc"><div class="contents"><div class="textblock"> </div></div> </div> </div><div id="nav-path" class="navpath"> <ul>
<li class="footer">
Generated by <a href="https://www.doxygen.org/index.html"><img src="doxygen.svg" alt="doxygen" style="pointer-events: none;" class="footer" width="104" height="31" class="inline"/></a> 1.9.1  </li>
</ul>
</div><p> &lt;/body&gt; &lt;/html&gt; </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
